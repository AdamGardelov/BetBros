@page "/login"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Elevation="4" Class="pa-8">
        <div style="text-align: center; margin-bottom: 2rem;">
            <img src="logo.png" alt="BetBros" style="max-width: 200px; width: 100%; height: auto;" />
        </div>

        <MudForm @ref="form" Class="mt-6">
            <MudTextField @bind-Value="username"
                          Label="Användarnamn"
                          Variant="Variant.Outlined"
                          Required="true"
                          HelperText="Ange ditt användarnamn"
                          OnKeyDown="HandleKeyDown" />

            <MudTextField @bind-Value="password"
                          Label="Lösenord"
                          Variant="Variant.Outlined"
                          InputType="InputType.Password"
                          Required="true"
                          HelperText="Ange ditt lösenord"
                          Class="mt-4"
                          OnKeyDown="HandleKeyDown" />

            <MudCheckBox @bind-Value="rememberMe" 
                       Label="Remember me" 
                       Class="mt-4" />

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">@errorMessage</MudAlert>
            }

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Class="mt-6"
                       OnClick="HandleLogin"
                       Disabled="isLoading">
                @if (isLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                }
                else
                {
                    <text>Logga in</text>
                }
            </MudButton>
        </MudForm>

        <MudDivider Class="my-6" />
        @* *@
        @* <MudText Typo="Typo.caption" Align="Align.Center"> *@
        @*     Testkonton: user1, user2, user3, user4 (lösenord: "password") *@
        @* </MudText> *@
    </MudPaper>
</MudContainer>

@code {
    private MudForm form = null!;
    private string username = string.Empty;
    private string password = string.Empty;
    private string errorMessage = string.Empty;
    private bool isLoading = false;
    private bool rememberMe = false;

    protected override async Task OnInitializedAsync()
    {
        // Load remembered username from localStorage
        try
        {
            var rememberedUsername = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "betbros_remembered_username");
            if (!string.IsNullOrEmpty(rememberedUsername))
            {
                username = rememberedUsername;
                rememberMe = true;
            }
        }
        catch
        {
            // localStorage might not be available, ignore
        }

        // Disabled auto-login to prevent redirect loops
        // Uncomment after authentication is working:
        // #if DEBUG
        //     await AutoLoginInDevelopment();
        // #endif
    }

    private async Task AutoLoginInDevelopment()
    {
        // Auto-login as gardelov in development
        var user = await AuthService.LoginAsync("gardelov", "password");
        if (user != null)
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isLoading)
        {
            // Use InvokeAsync to ensure UI state is updated before proceeding
            await InvokeAsync(async () =>
            {
                // Small delay to ensure form binding is complete
                await Task.Delay(100);
                StateHasChanged();
                await HandleLogin();
            });
        }
    }

    private async Task HandleLogin()
    {
        if (isLoading) return; // Prevent double submission
        
        // Check if fields have values (more reliable than form validation on first Enter)
        if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))
        {
            // Still validate form to show validation errors
            await form.Validate();
            return;
        }
        
        // Validate form
        await form.Validate();
        if (!form.IsValid)
        {
            return;
        }

        isLoading = true;
        errorMessage = string.Empty;
        StateHasChanged(); // Update UI to show loading state

        // Clear password field after reading (for security)
        var passwordToCheck = password;
        password = string.Empty;

        var user = await AuthService.LoginAsync(username, passwordToCheck);

        if (user != null)
        {
            // Handle "Remember me" functionality
            try
            {
                if (rememberMe)
                {
                    // Store username in localStorage
                    await JSRuntime.InvokeVoidAsync("localStorage.setItem", "betbros_remembered_username", username);
                }
                else
                {
                    // Remove from localStorage if unchecked
                    await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "betbros_remembered_username");
                }
            }
            catch
            {
                // localStorage might not be available, ignore
            }

            username = string.Empty; // Clear username on success
            Navigation.NavigateTo("/");
        }
        else
        {
            errorMessage = "Felaktigt användarnamn eller lösenord";
        }

        isLoading = false;
        StateHasChanged();
    }
}
