@page "/historik"
@using BetBros.Server.Enums
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IAuthService AuthService
@inject IGameWeekService GameWeekService
@inject IBetService BetService
@inject IDataStore DataStore

<PageTitle>Historik - BetBros</PageTitle>

<MudText Typo="Typo.h4" GutterBottom="true">Spelhistorik</MudText>

@if (_currentUser == null)
{
    <MudProgressCircular Indeterminate="true" />
}
else
{
    <MudPaper Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="6">
                <MudSelect Value="_selectedWeekId" 
                           Label="Vecka" 
                           Variant="Variant.Outlined"
                           ValueChanged="@((int value) => { _selectedWeekId = value; FilterResults(); })">
                    <MudSelectItem Value="0">Alla veckor</MudSelectItem>
                    @foreach (var week in _allWeeks.OrderByDescending(w => w.WeekNumber))
                    {
                        <MudSelectItem Value="@week.Id">Vecka @week.WeekNumber</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudSelect Value="_selectedUserId" 
                           Label="Spelare" 
                           Variant="Variant.Outlined"
                           ValueChanged="@((int value) => { _selectedUserId = value; FilterResults(); })">
                    <MudSelectItem Value="0">Alla spelare</MudSelectItem>
                    @foreach (var user in _allUsers)
                    {
                        <MudSelectItem Value="@user.Id">@user.DisplayName</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (!_groupedResults.Any())
    {
        <MudAlert Severity="Severity.Info">
            Ingen spelhistorik hittades för de valda filtren.
        </MudAlert>
    }
    else
    {
        <MudExpansionPanels MultiExpansion="true">
            @foreach (var group in _groupedResults.OrderByDescending(g => g.GameWeek.WeekNumber))
            {
                <MudExpansionPanel>
                    <TitleContent>
                        <MudGrid>
                            <MudItem xs="12" sm="3">
                                <MudText Typo="Typo.body1"><strong>Vecka @group.GameWeek.WeekNumber</strong></MudText>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                <MudText Typo="Typo.body2">@group.User.DisplayName</MudText>
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                @{
                                    var orderedBetsForEmojis = group.Bets.OrderBy(b => b.Game.CreatedAt).Take(3).ToList();
                                }
                                @for (int i = 0; i < 3; i++)
                                {
                                    @if (i > 0)
                                    {
                                        <text> </text>
                                    }
                                    @if (i < orderedBetsForEmojis.Count)
                                    {
                                        var bet = orderedBetsForEmojis[i];
                                        @if (!bet.Bet.ScoredAt.HasValue)
                                        {
                                            <text>○</text>
                                        }
                                        else if (bet.Bet.Status == BetStatus.Won)
                                        {
                                            <MudText Typo="Typo.body1" Color="Color.Success" Style="display: inline;">✓</MudText>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body1" Color="Color.Error" Style="display: inline;">✗</MudText>
                                        }
                                    }
                                    else
                                    {
                                        <text>-</text>
                                    }
                                }
                            </MudItem>
                            <MudItem xs="12" sm="3">
                                @{
                                    var netProfit = CalculateNetProfit(group.GameWeek, group.User, group.Bets);
                                }
                                @if (netProfit >= 0)
                                {
                                    <MudText Typo="Typo.body1" Color="Color.Success">
                                        <strong>+@netProfit.ToString("F0") kr</strong>
                                    </MudText>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body1" Color="Color.Error">
                                        <strong>@netProfit.ToString("F0") kr</strong>
                                    </MudText>
                                }
                            </MudItem>
                        </MudGrid>
                    </TitleContent>
                    <ChildContent>
                        <MudDivider Class="my-2" />
                        @{
                            var orderedBets = group.Bets.OrderBy(b => b.Game.CreatedAt).ToList();
                        }
                        @foreach (var betResult in orderedBets)
                        {
                            <MudPaper Class="pa-3 mb-2" Elevation="1">
                                <MudGrid>
                                    <MudItem xs="12">
                                        <MudText Typo="Typo.body1">
                                            <strong>@betResult.Game.HomeTeam vs @betResult.Game.AwayTeam</strong>
                                            @if (betResult.Game.HomeScore.HasValue && betResult.Game.AwayScore.HasValue)
                                            {
                                                <text> (@betResult.Game.HomeScore - @betResult.Game.AwayScore)</text>
                                            }
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        <MudText Typo="Typo.body2">
                                            <strong>Spel:</strong> @GetBetDisplayText(betResult.Bet)
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="12" sm="6">
                                        @if (betResult.Bet.ScoredAt.HasValue)
                                        {
                                            @if (betResult.Bet.Status == BetStatus.Won)
                                            {
                                                <MudText Typo="Typo.body2" Color="Color.Success">
                                                    <strong>✓ Vinst</strong>
                                                </MudText>
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.body2" Color="Color.Error">
                                                    <strong>✗ Förlust</strong>
                                                </MudText>
                                            }
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Default">
                                                Väntar på resultat
                                            </MudText>
                                        }
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        }
                        <MudDivider Class="my-2" />
                        <MudPaper Class="pa-3" Elevation="1">
                            <MudGrid>
                                <MudItem xs="12" sm="6">
                                    <MudText Typo="Typo.body1">
                                        <strong>Totalt för veckan</strong>
                                    </MudText>
                                </MudItem>
                                <MudItem xs="12" sm="6">
                                    @{
                                        var weekProfit = CalculateNetProfit(group.GameWeek, group.User, group.Bets);
                                    }
                                    @if (weekProfit >= 0)
                                    {
                                        <MudText Typo="Typo.body1" Color="Color.Success">
                                            <strong>+@weekProfit.ToString("F0") kr</strong>
                                        </MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body1" Color="Color.Error">
                                            <strong>@weekProfit.ToString("F0") kr</strong>
                                        </MudText>
                                    }
                                </MudItem>
                            </MudGrid>
                        </MudPaper>
                    </ChildContent>
                </MudExpansionPanel>
            }
        </MudExpansionPanels>
    }
}

@code {
    private User? _currentUser;
    private List<GameWeek> _allWeeks = [];
    private List<User> _allUsers = [];
    private List<BetResult> _allResults = [];
    private List<WeekUserGroup> _groupedResults = [];
    private int _selectedWeekId;
    private int _selectedUserId;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _currentUser = await AuthService.GetCurrentUserAsync();
        if (_currentUser == null)
            return;

        _allWeeks = GameWeekService.GetAllWeeks();
        _allUsers = DataStore.GetUsers();
        _allResults = BetService.GetAllBetResults();

        // Default to "show all" for both filters
        _selectedWeekId = 0;
        _selectedUserId = 0;

        FilterResults();
    }

    private void FilterResults()
    {
        var filtered = _allResults;

        if (_selectedWeekId > 0)
        {
            filtered = filtered.Where(r => r.GameWeek.Id == _selectedWeekId).ToList();
        }

        if (_selectedUserId > 0)
        {
            filtered = filtered.Where(r => r.User.Id == _selectedUserId).ToList();
        }

        // Group by GameWeek and User
        _groupedResults = filtered
            .GroupBy(r => new { GameWeekId = r.GameWeek.Id, UserId = r.User.Id })
            .Select(g => new WeekUserGroup
            {
                GameWeek = g.First().GameWeek,
                User = g.First().User,
                Bets = g.OrderBy(b => b.Game.CreatedAt).ToList()
            })
            .ToList();

        StateHasChanged();
    }


    private decimal CalculateNetProfit(GameWeek gameWeek, User user, List<BetResult> bets)
    {
        // If this user is the selector for this week, use the NetProfit from GameWeek
        // (this is the value entered on the EnterResults page)
        if (gameWeek.GameSelectorId == user.Id && gameWeek.NetProfit.HasValue)
        {
            return gameWeek.NetProfit.Value;
        }

        // For other users or if NetProfit is not set, calculate based on individual bet outcomes
        const decimal stakePerBet = 100m / 3m; // 33.33kr per bet
        decimal totalProfit = 0;

        foreach (var betResult in bets)
        {
            if (betResult.Bet.ScoredAt.HasValue)
            {
                if (betResult.Bet.Status == BetStatus.Won)
                {
                    // Win: get stake back + equal profit (net +33.33kr)
                    totalProfit += stakePerBet;
                }
                else
                {
                    // Loss: lose stake (net -33.33kr)
                    totalProfit -= stakePerBet;
                }
            }
            // Pending bets don't count towards profit/loss
        }

        return totalProfit;
    }

    private string GetBetKindText(BetType betKind)
    {
        return betKind switch
        {
            BetType.HomeWin or BetType.Draw or BetType.AwayWin or BetType.HomeWinToNil or BetType.AwayWinToNil => "1/X/2",
            BetType.OverOrUnder => "Över eller Under",
            BetType.ExactScore => "Exakt Resultat",
            _ => betKind.ToString()
        };
    }

    private string GetBetTypeText(BetType betType)
    {
        return betType switch
        {
            BetType.HomeWin => "1",
            BetType.HomeWinToNil => "1 + håller nollan",
            BetType.Draw => "X",
            BetType.AwayWin => "2",
            BetType.AwayWinToNil => "2 + håller nollan",
            BetType.Over => "Över",
            BetType.Under => "Under",
            BetType.ExactScore => "Exakt",
            _ => betType.ToString()
        };
    }

    private string GetBetDisplayText(Bet bet)
    {
        if (bet.Prediction == BetType.ExactScore)
        {
            return $"{bet.PredictedHomeScore}-{bet.PredictedAwayScore}";
        }
        return GetBetTypeText(bet.Prediction);
    }

    private class WeekUserGroup
    {
        public GameWeek GameWeek { get; set; } = null!;
        public User User { get; set; } = null!;
        public List<BetResult> Bets { get; set; } = [];
    }
}
